name: CD Pipeline

on:
  workflow_run:
    # CI Pipeline이 실행된 후 실행
    workflows: ["CI Pipeline"]
    types:
      - completed

jobs:
  deploy:
    # 리눅스 서버의 Runner에서 실행
    runs-on: self-hosted
   
    steps:
      # 현재 레포지토리 가져오기
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # DEPLOY-CONFIGS 레포지토리 가져오기
      - name: Checkout deploy-configs repository
        uses: actions/checkout@v4
        with:
          repository: channeling-re/DEPLOY-CONFIGS
          path: deploy-configs
      
      #S3에서 .env 파일 가져오기
      - name: Download .env from S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          PRIVATE_S3_BUCKET_NAME: ${{ secrets.PRIVATE_S3_BUCKET_NAME }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          aws s3 cp s3://$PRIVATE_S3_BUCKET_NAME/deploy/.env ./deploy-configs/.env


      # Docker 로그인
      - name: Login to Dockerhub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_ACCESS_TOKEN }}

      # fastapi-app이 실행중인 경우 중지
      - name: Stop fastapi-app
        run: |
          cd deploy-configs
          docker compose stop fastapi-app || true
          docker compose rm -f fastapi-app || true
      
      # kafka-consumer가 실행중인 경우 중지
      - name: Stop kafka-consumer
        run: |
          cd deploy-configs
          
          # overview-consumer 중지
          docker compose stop overview-consumer || true
          docker compose rm -f overview-consumer || true
          
          # analysis-consumer 중지
          docker compose stop analysis-consumer || true
          docker compose rm -f analysis-consumer || true

          # idea-consumer 중지
          docker compose stop idea-consumer || true
          docker compose rm -f idea-consumer || true

      # PostgreSQL이 실행중인 경우 중지
      - name: Stop PostgreSQL
        run: |
          cd deploy-configs
          docker compose stop postgres || true
          docker compose rm -f postgres || true


      # 이전 Docker 이미지 제거
      - name: Clean up old Docker images
        run: |
          # channeling-llm의 이전 Docker 이미지 제거(latest 제외)
          docker images ${{ secrets.DOCKER_USERNAME }}/channeling-llm -q | xargs -r docker rmi -f

          # dangling 이미지 제거
          docker image prune -f

      # Docker 이미지 Pull
      - name: Pull Docker image
        run: docker pull ${{ secrets.DOCKER_USERNAME }}/channeling-llm:latest



      # fastapi-app 다시 실행
      - name: Deploy fastapi-app
        working-directory: deploy-configs
        run: |
          # 환경 변수가 job 레벨에서 선언되어 자동으로 전달됨
          docker compose up -d --no-deps fastapi-app

      # overview-consumer 다시 실행
      - name: Deploy overview-consumer
        working-directory: deploy-configs
        run: |
          # 환경 변수가 job 레벨에서 선언되어 자동으로 전달됨
          docker compose up -d --no-deps overview-consumer

      # analysis-consumer 다시 실행
      - name: Deploy analysis-consumer
        working-directory: deploy-configs
        run: |
          # 환경 변수가 job 레벨에서 선언되어 자동으로 전달됨
          docker compose up -d --no-deps analysis-consumer

      # idea-consumer 다시 실행
      - name: Deploy idea-consumer
        working-directory: deploy-configs
        run: |
          # 환경 변수가 job 레벨에서 선언되어 자동으로 전달됨
          docker compose up -d --no-deps idea-consumer

        
